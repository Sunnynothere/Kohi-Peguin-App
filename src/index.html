<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Kōhi Peguin</title>
        <link rel="stylesheet" href="./styles/main.css">
        <link rel="manifest" href="/manifest.json">
        <meta name="theme-color" content="#d9d9d9">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="icon" href="/assets/penguin.png" type="image/x-icon">
    </head>

    <body>
        <div class="container">

            <!-- Pagina inicio -->
            <header class="start-page" id="startPage">
                <img src="/src/assets/kohipeguin.png" alt="title" class="title">
                <img src="/src/assets/penguin.png" alt="penguin" class="penguin-start">
                <p>Touch anywhere to start.</p>
            </header>

            <!-- Seccion de carga -->
            <section class="load-section" id="loadSection" style="display: none;">
                <div class="loading-area">
                    <img src="/src/assets/kohi-laying.png" alt="penguin-load" class="loading-penguin">
                    <img src="/src/assets/loading.png" alt="loading" class="loading-font">
                </div>
            </section>

            <!-- Seccion principal -->
            <section class="main-section" id="mainSection" style="display: none;">
                <div class="header-bar">
                    <button class="menu-btn" id="menuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="app-title">Kōhi Peguin</h1>
                    <div style="width: 48px;"></div>
                </div>
                <div class="main-text" id="mainTextImage">
                    <img src="/src/assets/reading-today.png" alt="reading-text">
                </div>

                <div id="statusArea"></div>

                <div id="bookList" class="book-list"></div>

                <div class="upload-area">
                    <input type="file" id="fileInput" accept=".epub" class="file-input" style="display:none;">
                    <button id="uploadBtn" class="upload-btn touch-feedback">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
            </section>

            <!-- Seccion de lectura -->
            <section class="book-section" id="bookSection" style="display: none;">
                <div class="book-header">
                    <button class="back-btn" id="backBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div id="bookTitle">Title</div>
                    <button class="back-btn" id="readModeBtn">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                
                <div id="viewer-container">
                    <div class="viewer"></div>
                </div>
                <div class="reading-progress" id="readingProgress"></div>

                <div class="book-nav">
                    <button id="prevPage" class="nav-btn touch-feedback">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <button id="nextPage" class="nav-btn touch-feedback">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </section>

            <!-- footer -->
            <footer class="footer">
                <p>© 2025 Kōhi Peguin. All rights reserved.</p>
            </footer>
            
        </div>

        <!-- Menu lateral -->
        <div class="side-menu" id="sideMenu" style="display: none;">
            <div class="menu-header">
                <h3>Options</h3>
                <button class="close-menu" id="closeMenu">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="menu-option">
                <i class="fas fa-moon"></i>
                <span>Dark Mode</span>
            </div>

            <div class="menu-option">
                <i class="fas fa-font"></i>
                <span>Font Configuration</span>
            </div>

            <div class="menu-option">
                <i class="fas fa-trash-alt"></i>
                <span>Clear Library</span>
            </div>

            <div class="menu-option">
                <i class="fas fa-into-circle"></i>
                <span>About</span>
            </div>
        </div>

        <!-- Overlay para menu -->
        <div class="overlay" id="overlay" style="display: none;"></div>

    </body>

    <!-- Scripts --> 
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sass.js/0.11.1/sass.sync.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const startPage = document.getElementById('startPage');
        const loadSection = document.getElementById('loadSection');
        const fileInput = document.getElementById('fileInput');
        const mainSection = document.getElementById('mainSection');
        const bookSection = document.getElementById('bookSection');
        const viewer = document.getElementById('viewer-container');
        const uploadBtn = document.getElementById('uploadBtn');
        const mainTextImage = document.getElementById('mainTextImage');
        const bookList = document.getElementById('bookList');
        const statusArea = document.getElementById('statusArea');
        const bookTitle = document.getElementById('bookTitle');
        const readingProgress = document.getElementById('readingProgress');
        const backBtn = document.getElementById('backBtn');
        const menuBtn = document.getElementById('menuBtn');
        const sideMenu = document.getElementById('sideMenu');
        const closeMenu = document.getElementById('closeMenu');
        const overlay = document.getElementById('overlay');
        const readModeBtn = document.getElementById('readModeBtn');

        let rendition;
        let openingBook = false;
        let currentBookName = '';
        let isReadMode = false;

        // Inicialización - Solo mostrar startPage
        startPage.style.display = 'flex';
        loadSection.style.display = 'none';
        mainSection.style.display = 'none';
        bookSection.style.display = 'none';
        sideMenu.style.display = 'none';
        overlay.style.display = 'none';

        initApp();

        function initApp() {
            // Event listeners
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            backBtn.addEventListener('click', goBackToMain);
            menuBtn.addEventListener('click', openMenu);
            closeMenu.addEventListener('click', closeSideMenu);
            overlay.addEventListener('click', closeSideMenu);
            readModeBtn.addEventListener('click', toggleReadMode);
        
            // Gestos táctiles para cambiar página
            setupTouchGestures();
        
            // Iniciar con un toque en cualquier lugar
            startPage.addEventListener('click', startApp);
        
            // Cargar libros al iniciar
            renderBookList();
        }
    
        function startApp() {
            startPage.style.display = 'none';
            loadSection.style.display = 'flex';
            
            setTimeout(() => {
                loadSection.style.display = 'none';
                mainSection.style.display = 'block';
            }, 2000);
        }
    
        function renderBookList() {
            let books = JSON.parse(localStorage.getItem('books') || '[]');
            bookList.innerHTML = '';
            
            if (books.length === 0) {
                bookList.style.display = 'none';
                mainTextImage.style.display = 'block';
                showStatus('No se encontraron libros. Sube un archivo EPUB para comenzar.', 'info');
                return;
            }
        
            bookList.style.display = 'grid';
            mainTextImage.style.display = 'none';
            statusArea.innerHTML = '';
        
            books.forEach(book => {
                const progress = localStorage.getItem(`progress_${book.name}`) || 0;
            
            const bookElement = document.createElement('div');
            bookElement.className = 'book-card touch-feedback';
            bookElement.innerHTML = `
                <button class="delete-btn" data-book="${book.name}">
                    <i class="fas fa-times"></i>
                </button>
                <img src="${book.cover || 'https://placehold.co/140x180/4e54c8/white?text=No+Cover'}" 
                     alt="${book.name}" class="book-cover">
                <div class="book-info">
                    <div class="book-title">${book.name}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;

            // Evento para cargar el libro
            bookElement.addEventListener('click', (e) => {
                if (!e.target.closest('.delete-btn')) {
                    loadBook(book.name);
                }
            });
            
            // Evento para eliminar el libro
            const deleteBtn = bookElement.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteBook(book.name);
            });
            
            bookList.appendChild(bookElement);
        });
    }

    function loadBook(bookName) {
        currentBookName = bookName;
        
        idbKeyval.get('epub_' + bookName).then(function(bookData) {
            if (bookData) {
                openingBook = true;
                showBookSection();
                
                // Limpiar visor
                viewer.innerHTML = '';
                
                // Mostrar título
                bookTitle.textContent = bookName;
                
                // Cargar el libro
                const epubBook = ePub(bookData);
                rendition = epubBook.renderTo(viewer, {
                    width: "100%",
                    height: "100%",
                    spread: 'none'
                });

                // Cargar última posición
                const savedCfi = localStorage.getItem('lastCfi_' + bookName);
                if (savedCfi) {
                    rendition.display(savedCfi);
                } else {
                    rendition.display();
                }
                
                // Actualizar progreso
                updateReadingProgress(bookName, savedCfi);
                
                // Guardar posición al cambiar de página
                rendition.on('relocated', function(location) {
                    localStorage.setItem('lastCfi_' + bookName, location.start.cfi);
                    
                    // Calcular y guardar progreso
                    const progress = calculateReadingProgress(location.start.cfi);
                    localStorage.setItem(`progress_${bookName}`, progress);
                    
                    // Actualizar visualización
                    updateReadingProgress(bookName, location.start.cfi);
                });
                
                // Configurar navegación
                setupNavigation();
            
                            } else {
                showStatus('Libro no encontrado en el almacenamiento. Por favor, vuelve a subirlo.', 'error');
            }
        }).catch(error => {
            console.error('Error loading book:', error);
            showStatus('Error al cargar el libro. Por favor, intenta nuevamente.', 'error');
        });
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
            if (file.name.toLowerCase().endsWith('.epub')) {
                openingBook = true;
                showBookSection();
                
                // Mostrar título
                bookTitle.textContent = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const bookData = e.target.result;
                    
                    // Guardar en IndexedDB
                    idbKeyval.set('epub_' + file.name, bookData).then(() => {
                        // Limpiar visor
                        viewer.innerHTML = '';
                        
                        // Cargar el libro
                        const book = ePub(bookData);
                        rendition = book.renderTo(viewer, {
                            width: "100%",
                            height: "100%",
                            spread: 'none'
                        });

                        rendition.display();
                        
                        // Guardar posición al cambiar de página
                        rendition.on('relocated', function(location) {
                            localStorage.setItem('lastCfi_' + file.name, location.start.cfi);

                            // Calcular y guardar progreso
                            const progress = calculateReadingProgress(location.start.cfi);
                            localStorage.setItem(`progress_${file.name}`, progress);
                            
                            // Actualizar visualización
                            updateReadingProgress(file.name, location.start.cfi);
                        });

                        // Configurar navegación
                        setupNavigation();

                        // Intentar obtener portada
                        book.loaded.cover.then(function(coverUrl) {
                            let books = JSON.parse(localStorage.getItem('books') || '[]');
                            if (!books.some(b => b.name === file.name)) {
                                books.push({
                                    name: file.name,
                                    cover: coverUrl
                                });
                                localStorage.setItem('books', JSON.stringify(books));
                                renderBookList();
                            }
                        }).catch(error => {
                            console.log('No se encontró portada para este libro');
                            let books = JSON.parse(localStorage.getItem('books') || '[]');
                            if (!books.some(b => b.name === file.name)) {
                                books.push({
                                    name: file.name,
                                    cover: null
                                });
                                localStorage.setItem('books', JSON.stringify(books));
                                renderBookList();
                            }
                        });
                        
                    }).catch(error => {
                        console.error('Error saving to IndexedDB:', error);
                        showStatus('Error al guardar el libro. Por favor, intenta nuevamente.', 'error');
                    });
                };

                reader.readAsArrayBuffer(file);
            } else {
                showStatus('Por favor, sube un archivo EPUB válido.', 'error');
            }
        } else {
            showStatus('No se seleccionó ningún archivo.', 'error');
        }
    }

    function deleteBook(bookName) {
        if (confirm(`¿Estás seguro de que quieres eliminar "${bookName}"?`)) {
            // Eliminar de IndexedDB
            idbKeyval.del('epub_' + bookName).then(() => {
                // Eliminar de la lista
                let books = JSON.parse(localStorage.getItem('books') || '[]');
                books = books.filter(book => book.name !== bookName);
                localStorage.setItem('books', JSON.stringify(books));
                
                // Eliminar progreso
                localStorage.removeItem('lastCfi_' + bookName);
                localStorage.removeItem(`progress_${bookName}`);
                
                showStatus(`"${bookName}" ha sido eliminado.`, 'success');
                
                // Actualizar lista
                renderBookList();
            }).catch(error => {
                console.error('Error deleting book:', error);
                showStatus('Error al eliminar el libro. Por favor, intenta nuevamente.', 'error');
            });
        }
    }

    function calculateReadingProgress(cfi) {
        if (!cfi) return 0;
        
        // Esta es una aproximación simple
        // En una implementación real, usaríamos la API de EPUB.js para un cálculo más preciso
        try {
            return Math.min(100, Math.max(0, Math.round((cfi.length / 500) * 100)));
        } catch (e) {
            console.error('Error calculating progress:', e);
            return 0;
        }
    }

    function updateReadingProgress(bookName, cfi) {
        if (cfi) {
            const progress = calculateReadingProgress(cfi);
            readingProgress.textContent = `Progreso: ${Math.round(progress)}%`;
            
            // Actualizar también en la lista principal
            const progressElement = document.querySelector(`.delete-btn[data-book="${bookName}"]`)
                ?.closest('.book-card')
                ?.querySelector('.progress-fill');
                
            if (progressElement) {
                progressElement.style.width = `${progress}%`;
            }
        } else {
            readingProgress.textContent = 'Progreso: 0%';
        }
    }

    function setupNavigation() {
        document.getElementById('prevPage').onclick = () => {
            if (rendition) rendition.prev();
        };
        
        document.getElementById('nextPage').onclick = () => {
            if (rendition) rendition.next();
        };
    }

    function setupTouchGestures() {
        let touchStartX = 0;
        let touchStartY = 0;
        
        viewer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, false);
        
        viewer.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            // Detectar deslizamiento horizontal (más horizontal que vertical)
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30) {
                if (deltaX > 0) {
                    // Deslizamiento a la derecha - página anterior
                    if (rendition) rendition.prev();
                } else {
                    // Deslizamiento a la izquierda - página siguiente
                    if (rendition) rendition.next();
                }
            }
        }, false);
    }

    function showBookSection() {
        mainSection.style.display = 'none';
        bookSection.style.display = 'block';
        isReadMode = false;
        bookSection.classList.remove('read-mode');
    }
    
    function goBackToMain() {
        bookSection.style.display = 'none';
        mainSection.style.display = 'block';
        viewer.innerHTML = '';
        readingProgress.textContent = '';
        renderBookList();
    }
    
    function openMenu() {
        sideMenu.style.display = 'block';
        sideMenu.classList.add('open');
        overlay.style.display = 'block';
    }
    
    function closeSideMenu() {
        sideMenu.classList.remove('open');
        overlay.style.display = 'none';
        setTimeout(() => {
            sideMenu.style.display = 'none';
        }, 300);
    }
    
    function toggleReadMode() {
        isReadMode = !isReadMode;
        bookSection.classList.toggle('read-mode', isReadMode);
    }
    
    function showStatus(message, type) {
        statusArea.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    });

    </script>
</html>